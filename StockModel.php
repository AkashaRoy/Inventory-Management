<?phpinclude_once 'Database.php';class StockModel extends Database{  /*function saveToDB()    {	$temp=0;	$a=0;	$args=func_get_args();	//var_dump($args);	$host='localhost';	$user='root';	$password='';	$database='vocational_training';	$link=mysqli_connect($host, $user, $password, $database);	$query1="SELECT sum(stock.quantity)\n"    . "FROM item, category,stock\n"    . "WHERE item.category_id = category.category_id\n"    . "and stock.item_id=item.item_id\n"    . "AND category.name = '$args[5]' AND item.item_id = '$args[1]' GROUP BY stock.item_id";	//echo $query1;	$result=mysqli_query($link,$query1);	if($result)	{	$a=0;	$row=mysqli_fetch_array($result);	$a=$row[0];	//echo $a;	}	$temp=0;	$temp=$a + $args[2];	echo "<br/>";	//echo $temp;	$query="INSERT INTO `stock` values(NULL,$args[0],$args[1],NULL,$args[2],$args[2],NULL,'$args[4]','$args[5]',$args[3])";	//echo $query;	echo "<br/>";	$res=mysqli_query($link, $query);	$query4= "update stock set current_stock=$temp where item_id=$args[1];";	//echo $query4;	$temp2=mysqli_query($link,$query4);	$query3= "UPDATE indent_item SET status=\"received\" WHERE item_id=$args[1] and purchase_order_id=$args[0];";	$temp1=mysqli_query($link,$query3);	$query5="select item.name_brand,indent_item.item_id,indent_item.quantity from item,indent_item,purchase_order where purchase_order.purchase_order_id=indent_item.purchase_order_id and indent_item.item_id=item.item_id and purchase_order.indent_id=indent_item.indent_id and indent_item.status=\"approved\" and purchase_order.purchase_order_id=$args[0]\n"    . "";		//echo $query5;	$res = mysqli_query($link, $query5);		$a=mysqli_num_rows($res);		//echo $a;	if($a==0)	{	$query6= "UPDATE purchase_order SET status=\"received\" WHERE purchase_order_id=$args[0];";	//echo $query6;	$temp=mysqli_query($link,$query6);	}	if($res)	{	$link1=mysqli_connect($host, $user, $password, $database);	$query1="select * from stock where stock_id=(select max(stock_id) from stock)";	$r=mysqli_query($link1,$query1);	if($r)	    {	    return $r;		}    }	else{	//$query3= "UPDATE purchase_order SET status=\"received\" WHERE purchase_order_id=$args[0];";	//echo $query3;	//$temp=mysqli_query($link,$query3);	//echo "not in model";	    return false;	}    }*/		    function fetchAllStockData($id)	{	/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();	//$query = "select item_id,category,sum(current_stock)\"stock\" from stock group by item_id,category";	//$query="select item_id,category,sum(current_stock)\"stock\" from stock where item_id=$id";	$query="select stock.item_id,stock.category,item.name_brand,sum(stock.current_stock)\"stock\"from stock,item where stock.item_id=$id and stock.item_id=item.item_id";	//echo $query;	$res = mysqli_query($link, $query);	//var_dump($res);		if($res)	{	//echo"<br/>item exist";	    return $res;		}	else{	//echo " <br/>item does not exist in model";	    return false;	}	}		function saveToDB()    {	$temp=0;	$a=0;	$c=0;	$args=func_get_args();	$host='localhost';	$user='root';	$password='';	$database='vocational_training';	$link=mysqli_connect($host, $user, $password, $database);	$query="SELECT stock.current_stock\n"    . "FROM item, category,stock\n"    . "WHERE item.category_id = category.category_id\n"    . "and stock.item_id=item.item_id\n"    . "AND category.name = '$args[5]' AND item.item_id = '$args[1]' GROUP BY stock.item_id";	//echo $query;	$result=mysqli_query($link,$query);	if($result)	{	$a=0;	$row=mysqli_fetch_array($result);	$a=$row[0];	//echo $a;	}	$temp=0;	$temp=$a + $args[2];	//echo $temp;	$query4="select sum(stock.quantity-stock.damaged_goods) from stock where stock.purchase_order_id=$args[0] and stock.item_id=$args[1]";	//echo $query4;	$temp4=mysqli_query($link,$query4);	$row4=mysqli_fetch_array($temp4);	$x4=$row4[0];	//echo $x4;	$query1="INSERT INTO `stock` values(NULL,$args[0],$args[1],NULL,$args[2],$args[2],NULL,'$args[4]','$args[5]',$args[3])";	//echo $query1;	$res=mysqli_query($link, $query1);	if($res)	{	//$query2= "update stock set current_stock=$temp where item_id=$args[1];";	//echo $query2;	//$temp2=mysqli_query($link,$query2);	//echo $args[3];	$b=$args[3];	$query3="select indent_item.quantity from indent_item,purchase_order where purchase_order.purchase_order_id=indent_item.purchase_order_id and  purchase_order.indent_id=indent_item.indent_id and indent_item.item_id=$args[1] and purchase_order.purchase_order_id=$args[0]";	//echo $query3; 	$temp3=mysqli_query($link,$query3);	$row3=mysqli_fetch_array($temp3);	$x3=$row3[0];	//echo $x3;	$y=$args[2] - $args[3];	//echo $y;	/*$query4="select sum(stock.quantity-stock.damaged_goods) from stock where stock.purchase_order_id=$args[0] and stock.item_id=$args[1]";	echo $query4;	$temp4=mysqli_query($link,$query4);	$row4=mysqli_fetch_array($temp4);	$x4=$row4[0];	echo $x4;*/	$total=$y + $x4;	if($total >= $x3)	{	$query5= "UPDATE indent_item SET status=\"received\" WHERE item_id=$args[1] and purchase_order_id=$args[0];";	$temp5=mysqli_query($link,$query5);	//echo $query5;	}	else	{	$query6= "UPDATE indent_item SET status=\"partial\" WHERE item_id=$args[1] and purchase_order_id=$args[0];";	$temp6=mysqli_query($link,$query6);	//echo $query6;	}	$query7="select item.name_brand,indent_item.item_id,indent_item.quantity from item,indent_item,purchase_order where purchase_order.purchase_order_id=indent_item.purchase_order_id and indent_item.item_id=item.item_id and purchase_order.indent_id=indent_item.indent_id and (indent_item.status=\"approved\" or indent_item.status=\"partial\") and purchase_order.purchase_order_id=$args[0]";	$temp7 = mysqli_query($link, $query7);	$result7=mysqli_num_rows($temp7); 	//echo $result7;	if($result7==0)	{	$query8= "UPDATE purchase_order SET status=\"received\" WHERE purchase_order_id=$args[0];";	//echo $query8;	$temp8=mysqli_query($link,$query8);	}	else 	{	$query9= "UPDATE purchase_order SET status=\"partial\" WHERE purchase_order_id=$args[0];";	//echo $query9;	$temp9=mysqli_query($link,$query9);	}	$query10="select * from stock where stock_id=(select max(stock_id) from stock)";	//echo $query10;	$temp10=mysqli_query($link,$query10);	if($temp10)	    {	    return $temp10;		}	}	else{	    return false;	}    }		function fetchAllItemCurrentStock(){/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();	$query="select stock.item_id,item.name_brand,category.name,sum(stock.current_stock) from item,category,stock where stock.item_id=item.item_id and item.category_id=category.category_id group by stock.item_id";	$result8 = mysqli_query($link, $query);if($result8){return $result8;}else{return false;}}function fetchAllMinimumItemCurrentStock(){/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();	$query="select stock.item_id,item.minimum_quantity,item.name_brand,category.name,sum(stock.current_stock) from item,category,stock where stock.item_id=item.item_id and item.category_id=category.category_id group by stock.item_id having sum(stock.current_stock)<(item.minimum_quantity)";	$result8 = mysqli_query($link, $query);	$r=mysqli_num_rows($result8);	if($r!=0){return $result8;}else{return false;}}function fetchrequestAllItemCurrentStock($id){/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();$query="select purchase_order.expected_date,purchase_order.purchase_order_id,purchase_order.status,stock.item_id,stock.quantity,stock.receive_date from purchase_order left outer join stock on purchase_order.purchase_order_id=stock.purchase_order_id where purchase_order.expected_date='$id'";//echo $query;$result8 = mysqli_query($link, $query);$result11=mysqli_num_rows($result8); if($result11!=0){//echo "asdfgh";return $result8;}else{//echo "not";return false;}}function fetchrequestAllStock($id){/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();$query="select * from stock where stock_id=$id";$result8 = mysqli_query($link, $query);$result11=mysqli_num_rows($result8); if($result11!=0){//echo "asdfgh";return $result8;}else{//echo "not";return false;}}    function issueToStudUpdateDB()    {	$sID = func_get_arg(0);	$item = func_get_arg(1);	$orignalIssueQuan = func_get_arg(2);	$issueQuan = $orignalIssueQuan;	$sum=0;/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();    $checkStudentQuery = "SELECT * FROM `student` WHERE student_id = $sID;";    $result=mysqli_query($link, $checkStudentQuery);    if(is_null($result) || is_bool($result))        return NULL;	$query="SELECT `current_stock`,`stock_id`,`category` FROM `stock` WHERE `item_id`=$item AND `current_stock`>0 ORDER BY `receive_date` ASC;";	$result=mysqli_query($link, $query);	$resultCopy=mysqli_query($link, $query);	while ($result && $row1 = mysqli_fetch_array($resultCopy)) {	    $sum+=$row1[0];	    $category=$row1[2];	}	if($sum<$issueQuan)	    return FALSE;	while ($row = mysqli_fetch_array($result)) {	    if($row[0]>=$issueQuan)	    {		$newCurrentStock=$row[0]-$issueQuan;		$issueQuan=0;	    }	    else {		$newCurrentStock=0;		$issueQuan=$issueQuan-$row[0];	    }	    $issueQuery="UPDATE `stock` SET `current_stock`=$newCurrentStock WHERE `stock_id`=$row[1];";	    $issueResult=mysqli_query($link, $issueQuery);	    $lastStockID=$row[1];	}	if($issueQuan!=0 && $issueQuan!=$orignalIssueQuan) {	    return NULL;    }	$queryForStudentStock="INSERT INTO `student_stock`(`stu_stock_id`, `stock_id`, `student_id`, `quantity`)				VALUES (NULL,$lastStockID,$sID,$orignalIssueQuan)";	$studentStockResult=mysqli_query($link, $queryForStudentStock);	if($studentStockResult)	    return $issueResult;	else{	    $date = date('Y-m-d',mktime(0,0,0,date("m"),date("d"),date("Y")));	    if($category=='')		$stockInsertionQuery="INSERT INTO `stock`(`quantity`, `current_stock`, `item_id`, `receive_date`)				    VALUES ($orignalIssueQuan,$orignalIssueQuan,$item, $date)";	    else		$stockInsertionQuery="INSERT INTO `stock`(`quantity`, `current_stock`,`category`, `item_id`, `receive_date`)				    VALUES ($orignalIssueQuan,$orignalIssueQuan,$category,$item, $date)";	    $stockReundResult=mysqli_query($link, $stockInsertionQuery);	    return FAlSE;	}	    	    }        function issueToDeptUpdateDB()    {	$deptID = func_get_arg(0);	$item = func_get_arg(1);	$orignalIssueQuan = func_get_arg(2);	$issueQuan = $orignalIssueQuan;	$sum=0;/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();			$query="SELECT `current_stock`,`stock_id`,`category` FROM `stock` WHERE `item_id`=$item AND `current_stock`>0 ORDER BY `receive_date` ASC;";	$result=mysqli_query($link, $query);	$resultCopy=mysqli_query($link, $query);	while ($result && $row1 = mysqli_fetch_array($resultCopy)) {	    $sum+=$row1[0];	    $category=$row1[2];	}	if($sum<$issueQuan)	    return FALSE;	while ($row = mysqli_fetch_array($result)) {	    if($row[0]>=$issueQuan)	    {		$newCurrentStock=$row[0]-$issueQuan;		$issueQuan=0;	    }	    else {		$newCurrentStock=0;		$issueQuan=$issueQuan-$row[0];	    }	    $issueQuery="UPDATE `stock` SET `current_stock`=$newCurrentStock WHERE `stock_id`=$row[1]";	    $issueResult=mysqli_query($link, $issueQuery);	    $lastStockID=$row[1];	    if($issueQuan==0)		break;	}	if($issueQuan!=0 && $issueQuan!=$orignalIssueQuan)	    return NULL;	$queryForDeptStock="INSERT INTO `department_stock`(`stock_id`, `department_id`, `quantity`)			    VALUES ($lastStockID, $deptID, $orignalIssueQuan)";	$deptStockResult=mysqli_query($link, $queryForDeptStock);		return $issueResult;    }    function fetchItemsIssuedAgainstStudent()  {        $sID = func_get_arg(0);/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        $query="SELECT `item_id`, student_stock.quantity, student.name, `issue_date`, `name_brand`                 FROM  `student_stock`                 NATURAL JOIN  `student`                 LEFT JOIN  `stock` ON  `student_stock`.stock_id =  `stock`.stock_id                NATURAL JOIN `item`                WHERE student_id = $sID ";        $result=mysqli_query($link, $query);        return $result;  }  function fetchItemsIssuedAgainstAllStudents()  {/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        $query="SELECT `item_id`,`student_id`, student_stock.quantity, student.name, `issue_date`, `name_brand`                 FROM  `student_stock`                 NATURAL JOIN  `student`                 LEFT JOIN  `stock` ON  `student_stock`.stock_id =  `stock`.stock_id                NATURAL JOIN `item`;";        $result=mysqli_query($link, $query);        return $result;  }    function fetchItemsIssuedAgainstDept()  {        $deptID = func_get_arg(0);/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        $query="SELECT `item_id`, department_stock.quantity, department.name, `issue_date`, `name_brand`                 FROM  `department_stock`                 NATURAL JOIN  `department`                 LEFT JOIN  `stock` ON  `department_stock`.stock_id =  `stock`.stock_id                NATURAL JOIN `item`                WHERE department_id = $deptID ";        $result=mysqli_query($link, $query);        return $result;  }  function fetchItemsIssuedAgainstAllDepts()  {/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        $query="SELECT `item_id`,`department_id` ,department_stock.quantity, department.name, `issue_date`, `name_brand`                 FROM  `department_stock`                 NATURAL JOIN  `department`                 LEFT JOIN  `stock` ON  `department_stock`.stock_id =  `stock`.stock_id                NATURAL JOIN `item`";        $result=mysqli_query($link, $query);        return $result;  }  function fetchItemInStockDetails()  {        $itemID = func_get_arg(0);/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        $query="SELECT SUM(  `current_stock` ) AS sum, `name_brand`             FROM  `stock` NATURAL JOIN `item`             WHERE  `item_id` = $itemID";        $result=mysqli_query($link, $query);        return $result;  }    function fetchIssueDetails()  {        $itemID = func_get_arg(0);        $categoryID = func_get_arg(1);        $day = func_get_arg(2);        $month = func_get_arg(3);        $year = func_get_arg(4);        $string = func_get_arg(5);/*                $host = 'localhost';        $user = 'root';        $password = '';        $database = 'vocational_training';        $link = parent::connectToDB();*/        $link = parent::connectToDB();        if($string == "student") {            $query="SELECT `item_id`,student_id, student_stock.quantity, student.name, `issue_date`, `name_brand`                     FROM  `student_stock`                     NATURAL JOIN  `student`                     LEFT JOIN  `stock` ON  `student_stock`.stock_id =  `stock`.stock_id                    NATURAL JOIN `item` ";            $count = 0;            if(!empty($day) && $day!= NULL)            {                if($count<1)                    $query .= " WHERE ";                else                    $query .= " AND ";                $query .= " DAYOFMONTH(student_stock.issue_date) = ".$day." ";                $count++;            }            if(!empty($month) && $month!= NULL)            {                if($count<1)                    $query .= " WHERE ";                else                    $query .= " AND ";                $query .= " MONTH(student_stock.issue_date) = ".$month." ";                $count++;            }            if(!empty($year) && $year!= NULL)            {                if($count<1)                    $query .= " WHERE ";                else                    $query .= " AND ";                $query .= " YEAR(student_stock.issue_date) = ".$year." ";                $count++;            }        }        else {            $query="SELECT `item_id`,`department_id` ,department_stock.quantity, department.name, `issue_date`, `name_brand`                 FROM  `department_stock`                 NATURAL JOIN  `department`                 LEFT JOIN  `stock` ON  `department_stock`.stock_id =  `stock`.stock_id                NATURAL JOIN `item`";                $count = 0;                if(!empty($day) && $day!= NULL)                {                    if($count<1)                        $query .= " WHERE ";                    else                        $query .= " AND ";                    $query .= " DAYOFMONTH(department_stock.issue_date) = ".$day." ";                    $count++;                }                if(!empty($month) && $month!= NULL)                {                    if($count<1)                        $query .= " WHERE ";                    else                        $query .= " AND ";                    $query .= " MONTH(department_stock.issue_date) = ".$month." ";                    $count++;                }                if(!empty($year) && $year!= NULL)                {                    if($count<1)                        $query .= " WHERE ";                    else                        $query .= " AND ";                    $query .= " YEAR(department_stock.issue_date) = ".$year." ";                    $count++;                }        }        if(!empty($itemID) && $itemID!= NULL)        {            if($count<1)                $query .= " WHERE ";            else                $query .= " AND ";            $query .= " `item_id` = ".$itemID." ";            $count++;        }        if(!empty($categoryID) && $categoryID!= NULL)        {            if($count<1)                $query .= " WHERE ";            else                $query .= " AND ";            $query .= " `category_id` = ".$categoryID." ";            $count++;        }        $result=mysqli_query($link, $query);        return $result;  }		}?>